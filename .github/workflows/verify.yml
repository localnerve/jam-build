name: Verify
on:
  push:
    branches: [ main, stage ]
  pull_request:
    branches: [ main, stage ]

env:
  NODE_VERSION: '24.12.0'
  REPORT_ARTIFACTS: 'false'

jobs:
  build_verify:
    runs-on: ubuntu-24.04
    name: 'Build, verify, and cache'
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
      - name: Setup Node with npm cache
        uses: actions/setup-node@395ad3262231945c25e8478fd5baf05154b1d79f # v6.1.0
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      - name: Install Npm Dependencies
        run: npm ci
      - name: Cache Playwright Browser Binaries
        uses: actions/cache@9255dc7a253b0ccc959486e2bca901246202afeb # v5.0.1
        id: playwright-cache
        with:
          path: ~/.cache/ms-playwright
          key: ${{ runner.os }}-playwright-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-playwright-
      - name: Install Playwright Browsers (if not cached)
        if: steps.playwright-cache.outputs.cache-hit != 'true'
        run: npx playwright install
      - name: Run Linter
        run: npm run lint
      - name: Check Production Build
        run: npm run build
      - name: Archive Build Stats
        if: success() && env.REPORT_ARTIFACTS == 'true'
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: jam-build-stats
          overwrite: true
          compresion-level: 9
          path: ./stats/
      - name: Build Docker Image
        run: npm run test:build    # builds jam-build-test:latest
      - name: Export Docker Image
        run: docker save jam-build-test:latest -o jam-build-test.tar
      - name: Upload Docker Image Artifact
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: docker-image
          overwrite: true
          path: jam-build-test.tar

  browser_tests:
    needs: build_verify
    strategy:
      fail-fast: false
      matrix:
        # Note: WebKit is tested locally on macOS due to GitHub Actions networking limitations
        # with TestContainers. See docs/testing.md for details.
        # label: ['webkit', 'firefox', 'chromium']
        label: ['firefox', 'chromium']
        os: ['ubuntu-24.04']
    runs-on: ${{ matrix.os }}
    name: 'Test ${{ matrix.label }} browser on ${{ matrix.os }}'
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
      - name: Setup Node with npm cache
        uses: actions/setup-node@395ad3262231945c25e8478fd5baf05154b1d79f # v6.1.0
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      - name: Install Npm Dependencies
        run: npm ci
      - name: Cache Playwright Browser Binaries
        uses: actions/cache@9255dc7a253b0ccc959486e2bca901246202afeb # v5.0.1
        id: playwright-cache
        with:
          path: ~/.cache/ms-playwright
          key: ${{ runner.os }}-playwright-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-playwright-
      - name: Install Playwright Browsers (if not cached)
        if: steps.playwright-cache.outputs.cache-hit != 'true'
        run: npx playwright install
      - name: Set Playwright Browser Path
        run: echo "PLAYWRIGHT_BROWSERS_PATH=$HOME/.cache/ms-playwright" >> $GITHUB_ENV
      - name: Install Playwright System Dependencies
        run: npx playwright install-deps
      - name: Download Docker Image Artifact
        uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7.0.0
        with:
          name: docker-image
      - name: Load Docker Image
        run: docker load -i jam-build-test.tar
      - name: Test ${{ matrix.label }}
        run: npm run test:${{ matrix.label }}
      - name: Archive Test Reports
        if: success() && matrix.label == 'chromium' && env.REPORT_ARTIFACTS == 'true'
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: test-reports
          overwrite: true
          compresion-level: 9
          path: |
            ./test-results/coverage/coverage-mutation-tests-0/
            ./test-results/audits/
            ./coverage/
            !./coverage/**/tmp

  cleanup:
    runs-on: ubuntu-24.04
    needs: browser_tests
    if: always()
    steps:
      - name: Delete Test Docker Image
        uses: geekyeggo/delete-artifact@f275313e70c08f6120db482d7a6b98377786765b # v5.1.0
        with:
          name: docker-image
          failOnError: false